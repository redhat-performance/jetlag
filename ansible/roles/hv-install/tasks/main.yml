---
# hv-install tasks

- name: Install packages
  dnf:
    name:
    - "@virtualization-host-environment"
    - virt-install
    - virt-viewer
    - gcc
    - python3-devel
    - python3-libvirt
    - rsync
    - ksmtuned
    state: present
    update_cache: true
    disable_gpg_check: yes

- name: Install python packages
  pip:
    name: sushy-tools
    version: 1.2.0

- name: Configure hugepages support
  when: enable_hugepages
  block:

  - name: Run grubby to add hugepages arguments
    command: grubby --update-kernel=ALL --args="default_hugepagesz={{ hugepage_size }} hugepagesz={{ hugepage_size }}"
    register: grub_updated

  - name: Set reboot required flag
    set_fact:
      hugepages_reboot_required: true
    when: grub_updated.changed

  - name: Create hugetlb-gigantic-pages.service file
    copy:
      dest: /usr/lib/systemd/system/hugetlb-gigantic-pages.service
      content: |
        [Unit]
        Description=HugeTLB Gigantic Pages Reservation
        DefaultDependencies=no
        Before=dev-hugepages.mount
        ConditionPathExists=/sys/devices/system/node
        ConditionKernelCommandLine=hugepagesz=1G

        [Service]
        Type=oneshot
        RemainAfterExit=yes
        ExecStart=/usr/lib/systemd/hugetlb-reserve-pages.sh

        [Install]
        WantedBy=sysinit.target

  - name: Create hugetlb-reserve-pages.sh
    template:
      src: hugetlb-reserve-pages.sh.j2
      dest: /usr/lib/systemd/hugetlb-reserve-pages.sh
      mode: "0755"
    register: hugetlb_script

  - name: Set reboot required flag
    set_fact:
      hugepages_reboot_required: true
    when: hugetlb_script.changed

  - name: Enable hugetlb-gigantic-pages.service
    systemd:
      enabled: true
      name: hugetlb-gigantic-pages.service

- name: Get coredns
  get_url:
    validate_certs: false
    force: true
    url: https://github.com/coredns/coredns/releases/download/v1.10.1/coredns_1.10.1_linux_amd64.tgz
    dest: /root/coredns_1.10.1_linux_amd64.tgz

- name: Untar coredns
  unarchive:
    src: /root/coredns_1.10.1_linux_amd64.tgz
    dest: /usr/local/bin
    remote_src: yes
    mode: 0700

- name: Setup chronyd
  template:
    src: chrony.conf.j2
    dest: /etc/chrony.conf
    backup: true
    mode: "0644"

- name: Ensure chronyd is running with new configuration
  systemd:
    state: restarted
    enabled: true
    name: chronyd

- name: Copying the public key to the root user's authorized_keys
  authorized_key:
    user: root
    state: present
    key: "{{ lookup('file', '{{ ssh_public_key_file }}') }}"

- name: Start and enable KSM
  systemd:
    state: started
    enabled: true
    name: ksm

- name: Start and enable KSMtuned
  systemd:
    state: started
    enabled: true
    name: ksmtuned

- name: Reboot hypervisor for hugepages configuration
  when:
  - enable_hugepages
  - hugepages_reboot_required | default(false)
  block:
  - name: Reboot hypervisor
    reboot:
      msg: "Rebooting to apply hugepages configuration"
      reboot_timeout: 600

  - name: Verify hugepages are configured
    shell: cat /proc/meminfo | grep -E "HugePages_Total|HugePages_Free|Hugepagesize"
    register: hugepages_status

  - name: Display hugepages status
    debug:
      msg: "{{ hugepages_status.stdout_lines }}"
