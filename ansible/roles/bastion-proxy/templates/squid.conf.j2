# Squid configuration for IPv6 forward proxy
# Generated by Jetlag bastion-proxy role

# Listening ports - IPv4 and IPv6
http_port {{ proxy_port }}
{% if proxy_listen_ipv6 %}
http_port [::]:{{ proxy_port }}
{% endif %}

# Cache configuration for container images
cache_mem 256 MB
maximum_object_size {{ proxy_max_object_size_mb }} MB
cache_dir ufs /var/spool/squid {{ proxy_cache_size_mb }} 16 256

# Logging
access_log daemon:/var/log/squid/access.log squid
cache_log /var/log/squid/cache.log

# ACL definitions
{% for network in proxy_allowed_networks %}
acl localnet src {{ network }}
{% endfor %}

# Safe ports (standard HTTP/HTTPS)
acl SSL_ports port 443
acl Safe_ports port 80
acl Safe_ports port 443
acl CONNECT method CONNECT

# Deny requests to unsafe ports
http_access deny !Safe_ports

# Deny CONNECT to non-SSL ports
http_access deny CONNECT !SSL_ports

# Allow HTTPS CONNECT tunneling (required for container registries)
http_access allow CONNECT SSL_ports

# Allow access from local networks
http_access allow localnet

# Allow localhost
http_access allow localhost

# Deny all other access
http_access deny all

# DNS settings - use system resolver
dns_nameservers {{ controlplane_network[0] | ansible.utils.nthhost(1) }}

# Refresh patterns for container images (cache aggressively)
refresh_pattern -i \.(rpm|deb|tar|gz|tgz|bz2|xz)$ 10080 90% 43200
refresh_pattern . 0 20% 4320

# Shutdown behavior
shutdown_lifetime 5 seconds
