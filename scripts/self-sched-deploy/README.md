# Self-Scheduling OCP Deployment

Interactive OCP deployment with QUADS self-scheduling lab assignment.

This tool provides an easy way to deploy an OpenShift cluster on Red Hat labs (Scale Lab, Performance Lab) by combining:
- **ansible-quads-ssm**: Self-service lab assignment via QUADS API
- **jetlag**: Assisted Installer-based OCP deployment

## Prerequisites

- **Jetlag environment**: Run `source bootstrap.sh` from the jetlag repo root to setup the virtual environment
- **GNU Make**: For running the Makefile
- **jq**: For JSON parsing (r630 server detection)
- **Pull Secret**: Download from [console.redhat.com](https://console.redhat.com/openshift/install/pull-secret)
- **SSH Keys**: Default `~/.ssh/id_rsa` and `~/.ssh/id_rsa.pub`
- **QUADS Account**: Access to the QUADS self-scheduling system

## Quick Start

```bash
# Bootstrap jetlag environment (from repo root)
source bootstrap.sh

# Navigate to the self-sched-deploy directory
cd scripts/self-sched-deploy

# Run full interactive deployment
make
```

The tool will:
1. Prompt for all required configuration
2. Clone/update the ansible-quads-ssm repository
3. Create QUADS assignment for lab hosts
4. Generate jetlag inventory
5. Setup the bastion node
6. Deploy the OCP cluster

## Usage

### Full Deployment

```bash
# Interactive deployment (prompts for all configuration)
make
```

### Individual Phases

Each phase prompts for required configuration:

```bash
make repos              # Clone/update ansible-quads-ssm repository
make create-assignment  # QUADS assignment
make inventory          # Generate jetlag inventory
make bastion            # Setup bastion node
make cluster            # Deploy OCP cluster
```

### Re-running Phases

To re-run specific phases after failures, simply run the individual target:

```bash
# Re-run cluster deployment only
make cluster

# Re-run bastion setup and cluster deployment
make bastion && make cluster
```

### Utility Commands

```bash
make status      # Show current deployment status
make clean       # Remove generated config and state files
make clean-all   # Also remove cloned repository
make help        # Show all available targets
```

## Configuration Options

The interactive prompts collect the following:

### QUADS Configuration
- **API Server**: QUADS server URL (e.g., `quads2.rdu2.scalelab.redhat.com`)
- **Username**: Your username (without domain)
- **User Domain**: Email domain (e.g., `redhat.com`)
- **Password**: QUADS password

### Lab Configuration
- **Lab**: `scalelab` or `performancelab`

### OCP Configuration
- **Build Type**: `ga` (General Availability), `dev` (Development), or `ci` (Continuous Integration)
- **Version**: OCP version (e.g., `latest-4.17`, `candidate-4.17`, `4.19.0-0.nightly-2025-02-25-035256`)

### Cluster Configuration
- **Cluster Type**: `mno` (Multi-Node OpenShift) or `sno` (Single-Node OpenShift)
- **Worker Count**: Number of worker nodes (MNO only)
- **Network Stack**: `ipv4`, `ipv6`, or `dual` (dual-stack)
- **IPv6 Mode** (IPv6 only): `proxy` (connected via forward proxy) or `disconnected` (local mirror registry)

### Paths
- **Pull Secret**: Path to your `pull-secret.txt` file (default: jetlag root)

## File Structure

```
scripts/self-sched-deploy/
├── Makefile                     # Main orchestration
├── prompt-config.sh             # Interactive configuration
├── check-r630.sh                # r630 server detection script
├── vars/
│   ├── config.env               # Generated: current run config
│   └── state.env                # Generated: assignment state
├── templates/
│   └── quads_config.yml.j2      # QUADS config template
├── repos/                       # Cloned repositories (gitignored)
│   └── ansible-quads-ssm/
└── README.md
```

The jetlag configuration is generated by copying `ansible/vars/all.sample.yml` and modifying it with `sed` based on user configuration.

## Automatic Assignment Detection

When you run any target, the tool checks for an existing assignment in `vars/state.env`. If found, it prompts whether to reuse the existing assignment or create a new one. This allows you to:

1. Resume a failed deployment without creating a new assignment
2. Re-run specific phases after fixing issues
3. Iterate on cluster configuration without waiting for new hosts

## Network Stacks

### IPv4 Single-Stack (default)
Standard IPv4-only deployment. No special requirements.

### IPv6 Single-Stack
IPv6-only deployment. When selected, an additional prompt asks for the connectivity mode:

- **proxy** (default): Connected deployment via a Squid forward proxy on the bastion. The bastion's dual-stack connectivity provides outbound access for the IPv6 cluster. No local registry mirror or image syncing required.
- **disconnected**: Full disconnected deployment with a local mirror registry (`setup_bastion_registry`, `use_bastion_registry`) and image syncing (`sync_operator_index`, `sync_ocp_release`).

### Dual-Stack
Both IPv4 and IPv6. Standard connected installation using the IPv4 network.

## Automatic Features

### r630 Server Detection
During inventory generation, the tool automatically detects if any allocated servers are Dell r630 models. If detected, it enables `reset_idrac: true` in the jetlag configuration to clear iDRAC job queues and reset the iDRAC service before deployment.

## Troubleshooting

### Assignment Failed
Check your QUADS credentials and ensure you have access to self-scheduling.

### Inventory Generation Failed
Verify the cloud name in `vars/state.env` matches an active QUADS assignment.

### Cluster Deployment Failed
Re-run with:
```bash
make cluster
```

The tool will prompt for configuration and use the existing assignment.
